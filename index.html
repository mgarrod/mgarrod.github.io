<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Light Pollution Test</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.28/"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://mgarrod.github.io/jquery.csv.min.js"></script>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
      
      #paneDiv {
        width: 270px;
        padding: 15px;
        font-size: 14px;
      }

      .slider {
        margin: 20px 0;
        height: 40px;
        width: 95%;
      }

    </style>

    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/ImageryTileLayer",
        "esri/Graphic",
        "esri/renderers/ClassBreaksRenderer",
        "esri/widgets/LayerList",
        "esri/widgets/Swipe",
        "esri/widgets/Expand",
        "esri/widgets/Slider"
      ], (
        Map,
        MapView,
        ImageryTileLayer,
        Graphic,
        ClassBreaksRenderer, LayerList, Swipe, Expand, Slider
      ) => {
        
        const renderer = {
          type: "class-breaks",  // autocasts as new ClassBreaksRenderer()
          field: "DN",
          classBreakInfos: [
            {minValue: 0,maxValue: 1.71,symbol: {type:"simple-fill",color:"#000000"}},
            {minValue: 1.72,maxValue: 10.44,symbol: {type:"simple-fill",color:"#252525"}},
            {minValue: 10.45,maxValue: 19.18,symbol: {type:"simple-fill",color:"#4b4b4b"}},
            {minValue: 19.19,maxValue: 27.91,symbol: {type:"simple-fill",color:"#646464"}},
            {minValue: 27.92,maxValue: 36.64,symbol: {type:"simple-fill",color:"#7d7d7d"}},
            {minValue: 36.65,maxValue: 45.37,symbol: {type:"simple-fill",color:"#4e5979"}},
            {minValue: 45.38,maxValue: 54.11,symbol: {type:"simple-fill",color:"#142c70"}},
            {minValue: 54.12,maxValue: 62.84,symbol: {type:"simple-fill",color:"#123488"}},
            {minValue: 62.85,maxValue: 71.57,symbol: {type:"simple-fill",color:"#1c48a6"}},
            {minValue: 71.58,maxValue: 60.30,symbol: {type:"simple-fill",color:"#2a66b7"}},
            {minValue: 60.31,maxValue: 89.04,symbol: {type:"simple-fill",color:"#3a86c5"}},
            {minValue: 89.05,maxValue: 97.77,symbol: {type:"simple-fill",color:"#438d91"}},
            {minValue: 97.78,maxValue: 106.5,symbol: {type:"simple-fill",color:"#488942"}},
            {minValue: 106.51,maxValue: 115.23,symbol: {type:"simple-fill",color:"#67922a"}},
            {minValue: 115.24,maxValue: 123.97,symbol: {type:"simple-fill",color:"#96a132"}},
            {minValue: 123.98,maxValue: 132.70,symbol: {type:"simple-fill",color:"#c1c03e"}},
            {minValue: 132.71,maxValue: 141.43,symbol: {type:"simple-fill",color:"#ebeb4d"}},
            {minValue: 141.44,maxValue: 150.17,symbol: {type:"simple-fill",color:"#fad84a"}},
            {minValue: 150.18,maxValue: 158.90,symbol: {type:"simple-fill",color:"#f18b36"}},
            {minValue: 158.91,maxValue: 167.63,symbol: {type:"simple-fill",color:"#e65628"}},
            {minValue: 167.64,maxValue: 176.36,symbol: {type:"simple-fill",color:"#da3c22"}},
            {minValue: 176.37,maxValue: 185.1,symbol: {type:"simple-fill",color:"#d33c4b"}},
            {minValue: 185.11,maxValue: 193.83,symbol: {type:"simple-fill",color:"#d260b3"}},
            {minValue: 193.84,maxValue: 202.56,symbol: {type:"simple-fill",color:"#d284f8"}},
            {minValue: 202.57,maxValue: 211.29,symbol: {type:"simple-fill",color:"#d7a6f9"}},
            {minValue: 211.3,maxValue: 220.03,symbol: {type:"simple-fill",color:"#ddc3fa"}},
            {minValue: 220.04,maxValue: 228.76,symbol: {type:"simple-fill",color:"#e6d2fc"}},
            {minValue: 228.77,maxValue: 237.49,symbol: {type:"simple-fill",color:"#efe2fd"}},
            {minValue: 237.5,maxValue: 246.22,symbol: {type:"simple-fill",color:"#f7f0fe"}},
            {minValue: 246.23,maxValue: 255,symbol: {type:"simple-fill",color:"#ffffff"}}
          ]
        };
        
        $.ajax({
          type: "GET",
          url: "https://wyominglightpollution.s3.amazonaws.com/tiflist.txt",
          dataType: "text",
          success: function(data) {
          
          	data = $.csv.toArrays(data)
          	
          	let layers = [];
          	for (let x=0;x < data.length;x++) {
          	  
          	  let alayer = data[x];
          	  
          	  let layer = new ImageryTileLayer({
                url: "https://wyominglightpollution.s3.amazonaws.com/" + alayer[0],
                bandIds: [1],
                interpolation: "bilinear",
                renderer: renderer,
                opacity: 0.75,
                title: alayer[1],
                visible: x == data.length - 1
              });
              layers.push(layer);
              
          	}
    
            const map = new Map({
              basemap: "hybrid",
              layers: layers
            });
    
            const view = new MapView({
              container: "viewDiv",
              map: map,
              zoom: 14,
              center: [-84.47317340969197, 39.236832007772286]
            });
            
            view.when().then(() => {
              var promiseLayers = [];
              for (let i=0;i < layers.length; i++) {
                promiseLayers.push(view.whenLayerView(layers[i]));
              }
              Promise.all(promiseLayers).then((newlayers) => {
                let extent = undefined;
                for (let i=0;i < newlayers.length; i++) {
                  extent = extent == undefined ? newlayers[i].fullExtent : extent.union(newlayers[i].fullExtent);
                }
                view.goTo(extent.expand(1.5));
              });
            });
            
            const layerList = new LayerList({
              view: view
            });
            const llExpand = new Expand({
              view: view,
              content: layerList,
              expanded: false
            });
            view.ui.add(llExpand, "top-left");
            
            const opacitySlider = new Slider({
              container: "opacity-slider",
              min: 0,
              max: 100,
              values: [ 75 ],
              steps: 1,
              snapOnClickEnabled: false,
              visibleElements: {
                labels: true,
                rangeLabels: true
              }
            });
            opacitySlider.on(["thumb-change", "thumb-drag"], function(evt) {
              for (let i=0;i < layers.length; i++) {
                layers[i].opacity = evt.value / 100;
              }
            });
    
            const swipe = new Swipe({
              leadingLayers: layers,
              //trailingLayers: [layer],
              position: 75,
              view: view
            });
    
            view.ui.add(swipe);
            
            view.ui.add([paneDiv], "bottom-left");
          	
          },
          error: function() { 
              console.log("error"); 
          } 
        });
        
      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
    <div id="paneDiv" class="esri-widget">
      <div id="opacity-slider" class="slider"></div>
    </div>
  </body>
</html>
